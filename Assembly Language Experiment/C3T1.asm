	.486
CRLF MACRO
	MOV AH,0EH
	MOV AL,0DH
	INT 10H
	MOV AL,0AH
	INT 10H
ENDM

DATAS SEGMENT USE16
      OLD0B DD ?
      MESG1 DB 'COMMUNICATION START:$'
      MESG2 DB 'TEST ENDS.$'
DATAS ENDS

STACKS SEGMENT USE16
    ;NULL
STACKS ENDS

CODES SEGMENT USE16
    ASSUME CS:CODES,DS:DATAS,SS:STACKS
START:
    MOV AX,DATAS
    MOV DS,AX
    CLI
    CALL I8259
    CALL I8250
    CALL RD0B
    CALL WROB
    STI
    ;发送与接收的开头合为一体
    MOV AH,09H
    MOV DX,OFFSET MESG1
    INT 21H
    CRLF;展示开始信息
BEG:
	MOV AH,07H
	INT 21H
	CMP AL,0DH;以回车为结束
	JZ LAST
	MOV AH,0
	PUSH AX
SCAN:;查询方式
	MOV DX,3FDH
	IN AL,DX
	TEST AL,20H;发送寄存器是否空
	JZ SCAN
	MOV DX,3F8H
	POP AX
	OUT DX,AL
	JMP BEG
LAST:
	CRLF
	MOV AH,9
	MOV DX,OFFSET MESG2
	INT 21H
	CALL RESET
	MOV AH,4CH
	INT 21H
;RECEIVER PART	
    
RD0B PROC
	MOV AX,350BH
	INT 21H
	MOV WORD PTR OLD0B,BX
	MOV WORD PTR OLD0B+2,ES
	RET
RD0B ENDP

WROB PROC
	PUSH DS
	MOV AX,CODES
	MOV DS,AX
	MOV DX,OFFSET RECEIVE
	MOV AX,250CH
	INT 21H
	POP DS
	RET
WROB ENDP

RECEIVE PROC 
	PUSH AX
	PUSH DX
	PUSH DS
	MOV AX,DATAS
	MOV DS,AX
	MOV DX,3F8H
	IN AL,DX
	MOV AH,02H
	MOV DL,AL
	INT 21H
	JMP EXIT
EXIT:
	MOV AL,20H
	OUT 20H,AL
	POP DS
	POP DX
	POP AX
	IRET
RECEIVE ENDP		
			    	
RESET PROC
	IN AL,21H
	OR AL,00010000B
	OUT 21H,AL
	MOV AX,250CH
	MOV DX,WORD PTR OLD0B
	MOV DS,WORD PTR OLD0B+2
	INT 21H
	RET
RESET ENDP		
    
I8250 PROC
	MOV DX,3FBH
	MOV AL,80H
	OUT DX,AL
	MOV DX,3F9H
	MOV AL,0
	OUT DX,AL
	MOV DX,3F8H
	MOV AL,40H
	OUT DX,AL;波特率0040H,1800
	MOV DX,3FBH
	MOV AL,0AH
	OUT DX,AL
	MOV DX,3F9H
	MOV AL,01H
	OUT DX,AL
	MOV DX,3FCH
	MOV AL,18H
	OUT DX,AL;内环
	RET
I8250 ENDP

I8259 PROC
	IN AL,21H
	AND AL,11101111B
	OUT 21H,AL
	RET
I8259 ENDP	

CODES ENDS
    END START
    
  



